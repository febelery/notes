## virtualbox 安装centos

### 网络设置

- 网卡一

  用`网络地址转换(NAT)`，其他设置不变，也不用端口转发

  这个网卡的主要作用就是用来访问外网

- 网卡二

  用`仅主机（Host-Only）网络`，`界面名称`需要提前virtualbox全局菜单栏设置

  `管理`-->`主机网络管理器`，这个网卡的主要作用就是用来虚拟机之间连接和和宿主机之间连接

  进入虚拟机后，查看网络二的名称`ip addr`，比如是`enp0s8`，执行如下命令

  ```ba
touch /etc/sysconfig/network-scripts/ifcfg-enp0s8
  ```
  
  ```shell
  TYPE=Ethernet
  PROXY_METHOD=none
  BROWSER_ONLY=no
  BOOTPROTO=static
  DEFROUTE=yes
  IPV4_FAILURE_FATAL=no
  IPV6INIT=yes
  IPV6_AUTOCONF=yes
  IPV6_DEFROUTE=yes
  IPV6_FAILURE_FATAL=no
  IPV6_ADDR_GEN_MODE=stable-privacy
  NAME=enp0s3
  UUID=53c8eb8b-db2d-4ed7-b404-bb0289092be1
  DEVICE=enp0s8
  ONBOOT=yes
  IPADDR=192.168.56.100 # 配置网络静态ip
  NETMASK=255.255.255.0
  GATEWAY=192.168.56.1
  DNS1=8.8.8.8
  DNS2=114.114.114.114
  ```
  
  ```shell
  nmcli c reload
  nmcli c up enp0s8
  ```
  
  

## 系统参数

- /etc/sysctl.d/k8s.conf

  ```shell
  net.bridge.bridge-nf-call-iptables=1
  net.bridge.bridge-nf-call-ip6tables=1
  net.ipv4.ip_forward=1
  net.ipv4.tcp_tw_recycle=1 # 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
  net.ipv4.tcp_keepalive_time=600 # 超过这个时间没有数据传输，就开始发送存活探测包
  net.ipv4.tcp_keepalive_intvl=15 # keepalive探测包的发送间隔
  net.ipv4.tcp_keepalive_probes=3 # 如果对方不予应答，探测包的发送次数
  vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它
  vm.overcommit_memory=1 # 不检查物理内存是否够用
  vm.panic_on_oom=0 # 开启 OOM
  fs.inotify.max_user_instances=8192
  fs.inotify.max_user_watches=1048576
  fs.file-max=52706963
  fs.nr_open=52706963
  net.ipv6.conf.all.disable_ipv6=1
  net.netfilter.nf_conntrack_max=2310720
  ```

  `syscel --system` or `syscel -p /etc/sysctl.d/k8s.conf`

- /etc/sysconfig/modules/ipvs.modules

  ```shell
  modprobe -- ip_vs
  modprobe -- ip_vs_rr
  modprobe -- ip_vs_wrr
  modprobe -- ip_vs_sh
  modprobe -- nf_conntrack_ipv4
  modprobe br_netfilter
  ```

  ```bash
  chmod 755 /etc/sysconfig/modules/ipvs.modules 
  bash /etc/sysconfig/modules/ipvs.modules
  lsmod | grep -e ip_vs -e nf_conntrack_ipv4
  ```



## 安装

> 安装参考  [高可用集群](https://www.funtl.com/zh/service-mesh-kubernetes/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.html)   [k8s高可用集群搭建](https://www.jianshu.com/p/3de558d8b57a)

![拓扑](https://s1.ax1x.com/2020/10/20/Bppnot.png)

- Keepalived 提供 `kube-apiserver` 对外服务的虚拟 IP（VIP）
- HAProxy 监听 Keepalived VIP
- 运行 Keepalived 和 HAProxy 的节点称为 LB（负载均衡） 节点
- Keepalived 是一主多备运行模式，故至少需要两个 LB 节点
- Keepalived 在运行过程中周期检查本机的 HAProxy 进程状态，如果检测到 HAProxy 进程异常，则触发重新选主的过程，VIP 将飘移到新选出来的主节点，从而实现 VIP 的高可用
- 所有组件（如 kubeclt、apiserver、controller-manager、scheduler 等）都通过 VIP +HAProxy 监听的 6444 端口访问 `kube-apiserver` 服务（**注意：`kube-apiserver` 默认端口为 6443，为了避免冲突我们将 HAProxy 端口设置为 6444，其它组件都是通过该端口统一请求 apiserver**）

### 节点配置


| 主机名               | IP             | 角色   |  CPU/内存 | 磁盘 |
| -------------------- | -------------- | ------ |  -------- | ---- |
| master-01 | 192.168.56.101 | Master |  2核2G    | 20G  |
| master-02 | 192.168.56.102 | Master |  2核2G    | 20G  |
| master-03 | 192.168.56.103 | Master |  2核2G    | 20G  |
| node-01   | 192.168.56.111 | Node   |  2核4G    | 20G  |
| node-02   | 192.168.56.112 | Node   |  2核4G    | 20G  |
| node-03   | 192.168.56.113 | Node   |  2核4G    | 20G  |
| VIP (virtual ip) | 192.168.56.50 | -      | -        | -    |

### HAProxy

> 替代方案LVS

```bash
dnf install haproxy
systemctl enable haproxy.service
vim /etc/haproxy/haproxy.cfg
```

```shell
global
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats

    # utilize system-wide crypto-policies
    ssl-default-bind-ciphers PROFILE=SYSTEM
    ssl-default-server-ciphers PROFILE=SYSTEM

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000

#---------------------------------------------------------------------
# main frontend which proxys to the backends
#---------------------------------------------------------------------
frontend main
    mode tcp
    bind *:5000
    acl url_static       path_beg       -i /static /images /javascript /stylesheets
    acl url_static       path_end       -i .jpg .gif .png .css .js

    use_backend static          if url_static
    default_backend             app

#---------------------------------------------------------------------
# static backend for serving up images, stylesheets and such
#---------------------------------------------------------------------
backend static
    balance     roundrobin
    server      static 127.0.0.1:4331 check

#---------------------------------------------------------------------
# round robin balancing between the various backends
#---------------------------------------------------------------------
backend app
    mode        tcp
    balance     roundrobin
    server  master01 192.168.56.101 check
    server  master02 192.168.56.102 check
    server  master03 192.168.56.103 check
```



### Keepalive

```bash
dnf install keepalive
systemctl enable keepalived.service
vim /etc/keepalived/keepalived.conf
```

```shell
! Configuration File for keepalived

global_defs {
    script_user root
    enable_script_security
}

vrrp_script chk_haproxy {
    script "/bin/bash -c 'if [[ $(netstat -nlp | grep 5000) ]]; then exit 0;fi'"
    interval 2
    weight 11
}

vrrp_instance VI_1 {
    state MASTER # 其他节点改为BACKUP
    interface enp0s8
    virtual_router_id 51
    priority 100
    advert_int 1
    nopreempt

    authentication {
        auth_type PASS
        auth_pass password 
    }
    virtual_ipaddress {
        192.168.56.50
    }
}

virtual_server 192.168.56.50 6443 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

  real_server 192.168.56.101 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
  real_server 192.168.56.102 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
  real_server 192.168.56.103 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
}
```

### Dashboard

参考这篇文章 [部署 Dashboard 和 metrics-server](https://tomoyadeng.github.io/blog/2019/08/11/k8s-dashboard-openssl/index.html)

查看token 
```bash
kubectl -n kube-system describe secret $(kubectl get secret --all-namespaces | grep admin | awk '{print $2}')
```



### 设置

- docker

  ```shell
  {
      "registry-mirrors":[
          "http://f1361db2.m.daocloud.io"
      ],
      "exec-opts":[
          "native.cgroupdriver=systemd"
      ]
  }
  ```

- dnf install iproute-tc && dnf provides tc first

- 安装calico非常重要的设置

  ```yaml
  $ kubeadm config print init-defaults --kubeconfig ClusterConfiguration > kubeadm.yml
...
  apiServer:
    timeoutForControlPlane: 4m0s
  apiVersion: kubeadm.k8s.io/v1beta1
  certificatesDir: /etc/kubernetes/pki
  clusterName: kubernetes
  controlPlaneEndpoint: "192.168.141.50:6444"
  controllerManager: {}
  dns:
    type: CoreDNS
  etcd:
    local:
      dataDir: /var/lib/etcd
  imageRepository: registry.aliyuncs.com/google_containers
  kind: ClusterConfiguration
  kubernetesVersion: v1.14.2
  networking:
    dnsDomain: cluster.local
    # 主要修改在这里，替换 Calico 网段为我们虚拟机不重叠的网段（这里用的是 Flannel 默认网段）
    podSubnet: "10.244.0.0/16"
    serviceSubnet: 10.96.0.0/12
  scheduler: {}
  ...
  ```
  ```yaml
  $ curl https://docs.projectcalico.org/manifests/calico.yaml -O
  ...
spec:
  containers:
    - env:
    - name: DATASTORE_TYPE
        value: kubernetes
      - name: IP_AUTODETECTION_METHOD  # DaemonSet中添加该环境变量
        value: interface=enp0s8   # 指定内网网卡，经过测试并没有啥用，加入集群要手动指定
      - name: WAIT_FOR_DATASTORE
        value: "true"
  ...
  ```
  



## 常见问题

#### kubeadm init 在主节点不成功

可以用`ip addr`查看当前VIP是否在此节点，如果不在次节点，可停止其他节点的keepalive `systemctl stop keepalived.service`

#### 在第三个master节点无法加入集群

提示`etcd`健康检查不成功

在virtualbox虚拟机中，可能每台虚拟机的`enp0s3`的IP地址一样。

可以用`kubectl describe configmaps kubeadm-config -n kube-system`查看第二台master的advertiseAddress是否和第三个节点的IP地址一样，可以手动指定advertiseAddress

`kubeadm join xxx --apiserver-advertise-address "your local machine ip"`

#### kubeadm默认证书只有一年有效期

```shell
kubeadm alpha certs check-expiration
```

参考 [更新一个10年有效期的 Kubernetes 证书](https://www.qikqiak.com/post/update-k8s-10y-expire-certs/) 这篇文章

#### `kubeadm join`使用的token过期后，如何加入集群

```bash
$ kubeadm token create
$ kubeadm token list
$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
	openssl rsa -pubin -outform der 2>/dev/null | \
	openssl dgst -sha256 -hex | sed 's/^.* //'
$ kubeadm join 192.168.56.50:6443 --token xx.xxx \
    --discovery-token-ca-cert-hash sha256:xxx
```

#### 查看`kubeadmin join`加入命令

```bash
kubeadm token create --print-join-command
```











