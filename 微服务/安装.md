## virtualbox 安装centos

### 网络设置

- 网卡一

  用`网络地址转换(NAT)`，其他设置不变，也不用端口转发

  这个网卡的主要作用就是用来访问外网

- 网卡二

  用`仅主机（Host-Only）网络`，`界面名称`需要提前virtualbox全局菜单栏设置

  `管理`-->`主机网络管理器`，这个网卡的主要作用就是用来虚拟机之间连接和和宿主机之间连接

  进入虚拟机后，查看网络二的名称`ip addr`，比如是`enp0s8`，执行如下命令

  ```ba
touch /etc/sysconfig/network-scripts/ifcfg-enp0s8
  ```
  
  ```shell
  TYPE=Ethernet
  PROXY_METHOD=none
  BROWSER_ONLY=no
  BOOTPROTO=static
  DEFROUTE=yes
  IPV4_FAILURE_FATAL=no
  IPV6INIT=yes
  IPV6_AUTOCONF=yes
  IPV6_DEFROUTE=yes
  IPV6_FAILURE_FATAL=no
  IPV6_ADDR_GEN_MODE=stable-privacy
  NAME=enp0s3
  UUID=53c8eb8b-db2d-4ed7-b404-bb0289092be1
  DEVICE=enp0s8
  ONBOOT=yes
  IPADDR=192.168.56.100 # 配置网络静态ip
  NETMASK=255.255.255.0
  GATEWAY=192.168.56.1
  DNS1=8.8.8.8
  DNS2=114.114.114.114
  ```
  
  ```shell
  nmcli c reload
  nmcli c up enp0s8
  ```
  
  

## 系统参数

- /etc/sysctl.d/k8s.conf

  ```shell
  net.bridge.bridge-nf-call-iptables=1
  net.bridge.bridge-nf-call-ip6tables=1
  net.ipv4.ip_forward=1
  net.ipv4.tcp_tw_recycle=1 # 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
  net.ipv4.tcp_keepalive_time=600 # 超过这个时间没有数据传输，就开始发送存活探测包
  net.ipv4.tcp_keepalive_intvl=15 # keepalive探测包的发送间隔
  net.ipv4.tcp_keepalive_probes=3 # 如果对方不予应答，探测包的发送次数
  vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它
  vm.overcommit_memory=1 # 不检查物理内存是否够用
  vm.panic_on_oom=0 # 开启 OOM
  fs.inotify.max_user_instances=8192
  fs.inotify.max_user_watches=1048576
  fs.file-max=52706963
  fs.nr_open=52706963
  net.ipv6.conf.all.disable_ipv6=1
  net.netfilter.nf_conntrack_max=2310720
  ```

  `syscel --system` or `syscel -p /etc/sysctl.d/k8s.conf`

- /etc/sysconfig/modules/ipvs.modules

  ```shell
  modprobe -- ip_vs
  modprobe -- ip_vs_rr
  modprobe -- ip_vs_wrr
  modprobe -- ip_vs_sh
  modprobe -- nf_conntrack_ipv4
  modprobe br_netfilter
  ```

  ```bash
  chmod 755 /etc/sysconfig/modules/ipvs.modules 
  bash /etc/sysconfig/modules/ipvs.modules
  lsmod | grep -e ip_vs -e nf_conntrack_ipv4
  ```



## 安装

> 安装参考  [高可用集群](https://www.funtl.com/zh/service-mesh-kubernetes/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4.html)   [k8s高可用集群搭建](https://www.jianshu.com/p/3de558d8b57a)

![拓扑](https://s1.ax1x.com/2020/10/20/Bppnot.png)

- Keepalived 提供 `kube-apiserver` 对外服务的虚拟 IP（VIP）
- HAProxy 监听 Keepalived VIP
- 运行 Keepalived 和 HAProxy 的节点称为 LB（负载均衡） 节点
- Keepalived 是一主多备运行模式，故至少需要两个 LB 节点
- Keepalived 在运行过程中周期检查本机的 HAProxy 进程状态，如果检测到 HAProxy 进程异常，则触发重新选主的过程，VIP 将飘移到新选出来的主节点，从而实现 VIP 的高可用
- 所有组件（如 kubeclt、apiserver、controller-manager、scheduler 等）都通过 VIP +HAProxy 监听的 6444 端口访问 `kube-apiserver` 服务（**注意：`kube-apiserver` 默认端口为 6443，为了避免冲突我们将 HAProxy 端口设置为 6444，其它组件都是通过该端口统一请求 apiserver**）

### 节点配置


| 主机名               | IP             | 角色   |  CPU/内存 | 磁盘 |
| -------------------- | -------------- | ------ |  -------- | ---- |
| master-01 | 192.168.56.101 | Master |  2核2G    | 20G  |
| master-02 | 192.168.56.102 | Master |  2核2G    | 20G  |
| master-03 | 192.168.56.103 | Master |  2核2G    | 20G  |
| node-01   | 192.168.56.111 | Node   |  2核4G    | 20G  |
| node-02   | 192.168.56.112 | Node   |  2核4G    | 20G  |
| node-03   | 192.168.56.113 | Node   |  2核4G    | 20G  |
| VIP (virtual ip) | 192.168.56.100 | -      | -        | -    |

### HAProxy

> 替代方案LVS

```bash
dnf install haproxy
systemctl enable haproxy.service
vim /etc/haproxy/haproxy.cfg
```

```shell
global
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats

    # utilize system-wide crypto-policies
    ssl-default-bind-ciphers PROFILE=SYSTEM
    ssl-default-server-ciphers PROFILE=SYSTEM

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000

#---------------------------------------------------------------------
# main frontend which proxys to the backends
#---------------------------------------------------------------------
frontend main
    mode tcp
    bind *:5000
    acl url_static       path_beg       -i /static /images /javascript /stylesheets
    acl url_static       path_end       -i .jpg .gif .png .css .js

    use_backend static          if url_static
    default_backend             app

#---------------------------------------------------------------------
# static backend for serving up images, stylesheets and such
#---------------------------------------------------------------------
backend static
    balance     roundrobin
    server      static 127.0.0.1:4331 check

#---------------------------------------------------------------------
# round robin balancing between the various backends
#---------------------------------------------------------------------
backend app
    mode        tcp
    balance     roundrobin
    server  master01 192.168.56.101 check
    server  master02 192.168.56.102 check
    server  master03 192.168.56.103 check
```



### Keepalive

```bash
dnf install keepalive
systemctl enable keepalived.service
vim /etc/keepalived/keepalived.conf
```

```shell
! Configuration File for keepalived

global_defs {
    script_user root
    enable_script_security
}

vrrp_script chk_haproxy {
    script "/bin/bash -c 'if [[ $(netstat -nlp | grep 5000) ]]; then exit 0;fi'"
    interval 2
    weight 11
}

vrrp_instance VI_1 {
    state MASTER # 其他节点改为BACKUP
    interface enp0s8
    virtual_router_id 51
    priority 100
    advert_int 1
    nopreempt

    authentication {
        auth_type PASS
        auth_pass password 
    }
    virtual_ipaddress {
        192.168.56.100
    }
}

virtual_server 192.168.56.100 6443 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

  real_server 192.168.56.101 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
  real_server 192.168.56.102 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
  real_server 192.168.56.103 6443 {
    weight 1
    TCP_CHECK {
      connect_timeout 10
      nb_get_retry 3
      delay_before_retry 3
      connect_port 6443
    }
  }
}
```







